# 完全实现Ext字段和Content字段查询功能 - 需求文档

## 1. 简介

本文档描述了完全实现Telegram搜索机器人中Ext字段和Content字段查询功能的需求。当前实现太过简陋，用户无法在意搜索结果具体来自哪个字段，但要求无论关键词出现在Content字段还是Ext字段中都能被搜索到。此功能旨在提供统一的、全面的搜索体验，确保用户能够通过任何搜索方式（简单搜索、语法搜索、短语搜索）在所有相关字段中找到匹配的结果。

## 2. 需求列表

### 2.1 统一搜索覆盖范围需求

**用户故事**: As a 机器人用户, I want 搜索功能能够同时覆盖Content字段和所有Ext字段, so that 我不需要关心具体信息存储在哪个字段，都能找到相关的搜索结果。

**验收标准**:
1. WHEN 用户执行任何类型的搜索（简单搜索、语法搜索、短语搜索）
   THEN 系统必须在Content字段和所有Ext字段中同时进行搜索
2. WHEN 用户搜索的关键词只出现在Content字段中
   THEN 系统必须能够返回包含该关键词的记录
3. WHEN 用户搜索的关键词只出现在某个Ext字段中
   THEN 系统必须能够返回包含该关键词的记录
4. WHEN 用户搜索的关键词同时出现在Content字段和Ext字段中
   THEN 系统必须能够返回所有包含该关键词的记录，不重复显示相同记录

### 2.2 分词处理一致性需求

**用户故事**: As a 搜索系统, I want 所有关键词都经过统一的分词处理, so that 中文分词能够正确工作，确保搜索的准确性和完整性。

**验收标准**:
1. WHEN 系统处理任何搜索查询
   THEN 必须使用SmartChineseAnalyzer对所有关键词进行分词处理
2. WHEN 搜索查询包含中文词语
   THEN 必须按照中文词语边界正确分词，而不是按单个字符分割
3. WHEN 搜索查询包含英文单词
   THEN 必须正确识别英文单词边界
4. WHEN 分词处理完成后
   THEN 必须去除重复的分词结果

### 2.3 短语查询完整性需求

**用户故事**: As a 用户, I want 使用引号包裹的短语查询能够在Content和Ext字段中正常工作, so that 我能够精确搜索特定的词组或句子。

**验收标准**:
1. WHEN 用户使用引号包裹的短语进行搜索（如："搜索词组"）
   THEN 系统必须在Content字段中构建短语查询
2. WHEN 用户使用引号包裹的短语进行搜索
   THEN 系统必须在所有Ext字段中构建短语查询
3. WHEN 短语查询匹配时
   THEN 必须保持词语的相对顺序和相邻关系
4. WHEN 短语出现在Ext字段中但不在Content字段中
   THEN 系统必须能够找到并返回该记录

### 2.4 字段指定搜索兼容性需求

**用户故事**: As a 高级用户, I want 使用字段指定语法（如 field:value）进行精确搜索, so that 我能够在特定字段中查找内容。

**验收标准**:
1. WHEN 用户使用字段指定语法进行搜索（如 "Ext_Username:张三"）
   THEN 系统必须能够正确解析字段名和字段值
2. WHEN 字段指定搜索指向已存在的字段
   THEN 系统必须只在指定字段中进行搜索
3. WHEN 字段指定搜索指向Ext字段
   THEN 系统必须正确处理Ext字段的搜索逻辑
4. WHEN 字段指定搜索指向Content字段
   THEN 系统必须正确处理Content字段的搜索逻辑

### 2.5 排除关键词搜索功能需求

**用户故事**: As a 用户, I want 使用排除符号（-）来排除包含特定关键词的结果, so that 我能够精确控制搜索结果的范围。

**验收标准**:
1. WHEN 用户使用排除符号进行搜索（如 "搜索词 -排除词"）
   THEN 系统必须在构建查询时正确处理排除逻辑
2. WHEN 排除关键词出现在Content字段中
   THEN 系统必须排除包含该关键词的记录
3. WHEN 排除关键词出现在Ext字段中
   THEN 系统必须排除包含该关键词的记录
4. WHEN 记录包含搜索关键词但不包含排除关键词
   THEN 系统必须正常返回该记录

### 2.6 搜索结果统一性需求

**用户故事**: As a 用户, I want 获得统一的搜索体验, so that 我不需要关心搜索结果具体来自哪个字段，只需要得到最相关的结果。

**验收标准**:
1. WHEN 系统返回搜索结果
   THEN 结果的排序应该基于相关性，而不是字段来源
2. WHEN 同一条记录在Content字段和Ext字段中都匹配了搜索词
   THEN 该记录在结果中只应该出现一次，不应该重复
3. WHEN 用户使用不同的搜索方式（简单搜索vs语法搜索）
   THEN 对于相同的查询，应该返回一致的搜索结果
4. WHEN 搜索结果展示时
   THEN 不需要特别标识结果来自哪个字段

### 2.7 性能和稳定性需求

**用户故事**: As a 系统管理员, I want 搜索功能在支持多字段搜索的同时保持良好的性能, so that 用户能够快速获得搜索结果。

**验收标准**:
1. WHEN 在多字段环境中执行搜索
   THEN 搜索响应时间不应该明显增加（增加不超过20%）
2. WHEN 系统处理大量Ext字段的记录
   THEN 内存使用量应该在合理范围内
3. WHEN 并发用户执行搜索操作
   THEN 系统必须保持稳定，不出现内存泄漏或崩溃
4. WHEN 搜索查询包含大量关键词
   THEN 系统必须能够正确处理而不出现异常

### 2.8 向后兼容性需求

**用户故事**: As a 现有用户, I want 升级后的搜索功能保持与现有查询的兼容性, so that 我现有的使用方式不受影响。

**验收标准**:
1. WHEN 使用现有版本的搜索查询
   THEN 新版本必须能够正确处理并返回相同或更好的结果
2. WHEN 使用已有的复杂查询语法
   THEN 新版本必须保持语法的一致性
3. WHEN 依赖现有的排序逻辑
   THEN 新版本应该保持或改进排序算法
4. WHEN 使用现有的API接口
   THEN 接口签名和返回格式不应该发生变化