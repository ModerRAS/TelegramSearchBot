# 项目重构：模块化拆分需求文档

## 简介

当前TelegramSearchBot项目将所有功能集中在一个项目中，特别是那些复杂的、与Telegram Bot核心功能关系不大的模块（如AI服务、搜索引擎、向量数据库等）混在一起，导致代码组织混乱。本项目重构旨在将那些独立性强、复杂度高的模块拆分为独立项目，提高代码的可维护性，并为这些复杂模块提供更好的测试和扩展能力。

## 需求

### 1. 搜索引擎模块独立化
**用户故事**：作为开发人员，我想要将Lucene.NET搜索相关功能拆分为独立项目，因为这是一个复杂的、可重用的搜索引擎模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.Search项目
- 当查看搜索项目时，应该包含索引管理、搜索查询、分词处理等完整功能
- 当其他项目引用搜索项目时，应该只能通过接口访问搜索功能
- 当替换搜索引擎实现时，不应该影响到Telegram Bot主项目

### 2. 向量数据库模块独立化
**用户故事**：作为开发人员，我想要将FAISS向量数据库相关功能拆分为独立项目，因为这是一个专业的向量存储和检索模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.Vector项目
- 当查看向量项目时，应该包含向量存储、相似性搜索、向量操作等功能
- 当项目依赖向量功能时，应该通过抽象接口引用，不直接依赖FAISS实现
- 当更换向量数据库技术时，只需要修改向量项目

### 3. AI服务模块独立化
**用户故事**：作为开发人员，我想要将AI服务（OCR、ASR、LLM）相关功能拆分为独立项目，因为这些是复杂的、独立的AI处理模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.AI项目
- 当查看AI项目时，应该包含OCR、ASR、LLM等独立的AI服务组件
- 当使用AI功能时，应该通过统一的AI服务接口调用
- 当添加新的AI服务提供商时，只需要在AI项目中扩展

### 4. 数据访问层抽象化
**用户故事**：作为开发人员，我想要将数据访问和仓储层拆分为独立项目，因为这是一个复杂的数据持久化模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.Data项目
- 当查看数据项目时，应该包含EF Core实体、仓储接口、数据库配置等
- 当业务逻辑需要数据访问时，应该通过仓储接口访问，不直接依赖EF Core
- 当更换数据库技术时，只需要修改数据项目实现

### 5. 消息处理引擎模块化
**用户故事**：作为开发人员，我想要将消息处理和事件总线相关功能拆分为独立项目，因为这是一个复杂的消息处理框架。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.Messaging项目
- 当查看消息项目时，应该包含消息处理器、事件总线、MediatR集成等
- 当添加新的消息处理逻辑时，应该通过消息处理框架扩展
- 当测试消息处理流程时，应该能够独立测试消息处理逻辑

### 6. 配置管理模块独立化
**用户故事**：作为开发人员，我想要将配置管理和依赖注入拆分为独立项目，因为这是一个复杂的基础设施模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.Core项目
- 当查看核心项目时，应该包含配置模型、服务注册、通用工具类等
- 当其他模块需要配置时，应该通过核心项目提供的配置服务
- 当修改配置结构时，只需要修改核心项目

### 7. 状态机引擎模块独立化
**用户故事**：作为开发人员，我想要将复杂的状态机逻辑（特别是配置编辑状态机）拆分为独立项目，因为这是一个复杂的多状态管理模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.StateMachine项目
- 当查看状态机项目时，应该包含通用状态机接口、LLM配置状态机、状态存储抽象等
- 当使用状态机功能时，应该通过统一的状态机接口调用，不直接依赖具体实现
- 当添加新的状态机流程时，应该能够通过状态机框架轻松扩展
- 当测试状态机逻辑时，应该能够独立测试各个状态转换

### 8. 日志和监控模块独立化
**用户故事**：作为开发人员，我想要将日志记录和监控相关功能拆分为独立项目，因为这是一个复杂的可观测性模块。

**验收标准**：
- 当查看项目结构时，应该看到独立的TelegramSearchBot.Telemetry项目
- 当查看遥测项目时，应该包含日志配置、指标收集、分布式追踪等
- 当应用程序需要记录日志时，应该通过遥测项目提供的接口
- 当更换日志提供商时，只需要修改遥测项目

### 9. Telegram Bot核心项目简化
**用户故事**：作为开发人员，我想要简化主项目，只保留Telegram Bot相关的核心功能，让主项目更聚焦。

**验收标准**：
- 当查看主项目时，应该只包含Bot控制器、命令处理、Webhook处理等核心功能
- 当查看主项目依赖时，应该清晰依赖各个独立模块
- 当修改Bot交互逻辑时，不应该影响到拆分出去的复杂模块
- 当添加新的Bot命令时，应该在主项目中完成，不涉及其他模块

### 10. 模块间依赖关系清晰化
**用户故事**：作为开发人员，我想要清晰的模块间依赖关系，避免循环依赖和过度耦合。

**验收标准**：
- 当查看解决方案依赖图时，应该看到清晰的分层结构
- 当检查项目引用时，应该不存在循环依赖
- 当修改一个模块时，应该明确知道哪些模块会受到影响
- 当添加新功能时，应该清楚应该在哪个模块中实现

### 11. 测试项目独立化
**用户故事**：作为开发人员，我想要为每个复杂模块创建独立的测试项目，以便能够更好地测试这些复杂功能。

**验收标准**：
- 当查看解决方案时，应该看到每个复杂模块都有对应的测试项目
- 当运行模块测试时，应该能够独立测试每个模块的功能
- 当编写测试时，应该能够模拟模块的外部依赖
- 当重构模块实现时，应该有完整的测试覆盖

## 边界情况考虑

### 性能考虑
- 模块化不应该显著影响应用程序启动时间
- 项目间的依赖关系不应该导致编译时间过长
- 内存使用应该在合理范围内

### 向后兼容性
- 重构后应该保持现有的功能完整性
- 配置文件和数据格式应该保持兼容
- API接口应该保持不变

### 迁移路径
- 应该提供清晰的迁移步骤
- 数据迁移应该无损
- 应该支持渐进式迁移

### 开发体验
- IDE支持应该良好（智能感知、调试等）
- 开发环境设置应该简单
- 文档应该更新以反映新的项目结构

### 重构风险控制
**用户故事**：作为开发人员，我想要重构风险控制措施，以避免重构过程中破坏现有功能。

**验收标准**：
- 当开始重构时，应该有完整的自动化测试覆盖所有状态转换场景
- 当重构某个状态机时，应该能够通过适配器模式保持原有接口兼容
- 当重构失败时，应该能够快速回滚到原有实现
- 当重构过程中发现问题时，应该有明确的修复路径和验证机制

### 渐进式重构策略
**用户故事**：作为开发人员，我想要采用渐进式重构策略，以便能够分步验证每个重构步骤的正确性。

**验收标准**：
- 当重构状态机时，应该先提取接口和抽象层，再实现具体功能
- 当拆分模块时，应该先创建新项目，再逐步迁移代码，最后删除原代码
- 当测试重构结果时，应该每个步骤都有对应的测试验证
- 当遇到重构困难时，应该能够暂停并在保持功能完整性的情况下重新评估

### 待合并PR的兼容性处理
**用户故事**：作为开发人员，我想要确保项目重构不会影响待合并PR的正常合并，以便能够顺利集成已完成的开发工作。

**验收标准**：
- 当重构项目结构时，应该为Lucene相关的待合并PR预留合并路径
- 当拆分搜索引擎模块时，应该保持Lucene相关代码的文件结构和逻辑不变
- 当创建新项目结构时，应该能够通过简单的文件移动完成Lucene模块的迁移
- 当PR准备合并时，应该提供清晰的合并指南和冲突解决方案
- 当重构完成后，应该确保Lucene PR的功能完整性不受影响