# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Pull requests Check

on:
  pull_request:
    branches: [ "master" ]
  push:
    branches: [ "dev" ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x
    - name: Clear NuGet cache
      run: dotnet nuget locals all --clear
    - name: Restore dependencies
      run: dotnet restore --force --no-cache
    - name: Build
      run: dotnet build --no-restore --configuration Release
    
    - name: Check code formatting
      if: matrix.os == 'windows-latest'
      run: dotnet format --verify-no-changes
    
    - name: Run security analysis
      if: matrix.os == 'windows-latest'
      run: dotnet list package --vulnerable --include-transitive
    
    - name: Test
      run: dotnet test --no-build --verbosity normal --configuration Release --collect:"XPlat Code Coverage"
    
    - name: Upload coverage to Codecov
      if: matrix.os == 'windows-latest'
      uses: codecov/codecov-action@v5
      with:
        file: ./TestResults/**/*.xml
        flags: pr-check
        name: pr-${{ github.event.number }}-${{ matrix.os }}
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}
        path: TestResults/

  report:
    needs: build
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    
    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
    
    - name: Generate PR report
      run: |
        echo "# ğŸ” PRæ£€æŸ¥æŠ¥å‘Š" > pr-report.md
        echo "" >> pr-report.md
        echo "## ğŸ“‹ æ£€æŸ¥æ¦‚è§ˆ" >> pr-report.md
        echo "- **PR**: #${{ github.event.number }}" >> pr-report.md
        echo "- **åˆ†æ”¯**: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}" >> pr-report.md
        echo "- **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}" >> pr-report.md
        echo "- **æäº¤**: ${{ github.sha }}" >> pr-report.md
        echo "" >> pr-report.md
        
        echo "## ğŸ§ª æµ‹è¯•ç»“æœ" >> pr-report.md
        echo "| å¹³å° | çŠ¶æ€ | è¯¦æƒ… |" >> pr-report.md
        echo "|------|------|------|" >> pr-report.md
        
        if [ -d "test-results-ubuntu-latest" ]; then
          echo "| Ubuntu | ğŸŸ¢ å·²å®Œæˆ | æŸ¥çœ‹æµ‹è¯•ç»“æœ |" >> pr-report.md
        else
          echo "| Ubuntu | ğŸ”´ å¤±è´¥ | æµ‹è¯•ç»“æœä¸å¯ç”¨ |" >> pr-report.md
        fi
        
        if [ -d "test-results-windows-latest" ]; then
          echo "| Windows | ğŸŸ¢ å·²å®Œæˆ | æŸ¥çœ‹æµ‹è¯•ç»“æœ |" >> pr-report.md
        else
          echo "| Windows | ğŸ”´ å¤±è´¥ | æµ‹è¯•ç»“æœä¸å¯ç”¨ |" >> pr-report.md
        fi
        echo "" >> pr-report.md
        
        echo "## ğŸ“Š ä»£ç è´¨é‡" >> pr-report.md
        echo "- âœ… ä»£ç æ ¼å¼åŒ–æ£€æŸ¥" >> pr-report.md
        echo "- âœ… å®‰å…¨æ¼æ´æ‰«æ" >> pr-report.md
        echo "- âœ… ä¾èµ–åŒ…åˆ†æ" >> pr-report.md
        echo "- âœ… ä»£ç è¦†ç›–ç‡æ”¶é›†" >> pr-report.md
        echo "" >> pr-report.md
        
        echo "## ğŸ“ æµ‹è¯•äº§ç‰©" >> pr-report.md
        echo "- æµ‹è¯•ç»“æœæ–‡ä»¶å·²ä¸Šä¼ ä¸ºartifacts" >> pr-report.md
        echo "- ä»£ç è¦†ç›–ç‡å·²ä¸Šä¼ åˆ°Codecov" >> pr-report.md
        echo "" >> pr-report.md
        
        echo "## ğŸ”— ç›¸å…³é“¾æ¥" >> pr-report.md
        echo "- [PRé¡µé¢](${{ github.event.pull_request.html_url }})" >> pr-report.md
        echo "- [Actionsæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> pr-report.md
        echo "" >> pr-report.md
        
        echo "---" >> pr-report.md
        echo "*æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> pr-report.md
    
    - name: Find existing comment
      if: always()
      uses: actions/github-script@v7
      id: find-comment
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸ” PRæ£€æŸ¥æŠ¥å‘Š')
          );
          
          return botComment?.id;
    
    - name: Create or update comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportPath = './pr-report.md';
          const report = fs.readFileSync(reportPath, 'utf8');
          
          const commentId = '${{ steps.find-comment.outputs.result }}';
          
          if (commentId) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              comment_id: commentId,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }
