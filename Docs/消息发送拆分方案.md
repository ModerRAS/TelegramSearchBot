## 实施计划概述

**项目名称**: `TelegramSearchBot.BotAPI`

**主要目标**:
1. 将消息发送相关代码（Manager、Service、View、Helper）从主项目拆分出来
2. 创建独立的 BotAPI 扩展库，提供速率限制、消息发送、流式处理等功能
3. 保持向后兼容，最小化主项目的修改

## 核心迁移组件

### 1. **Manager 层**
- SendMessage.cs - 速率限制和任务队列管理（GroupLimit + GlobalLimit）

### 2. **Service 层**
- SendMessageService.cs - 主服务类（构造函数、基础方法）
- SendMessageService.Standard.cs - 标准发送方法（文本、图片、文档、视频）
- SendMessageService.Streaming.cs - 流式消息发送（增量更新、完整流）

### 3. **View 层**
- ImageView.cs - 图片消息视图（Fluent API）
- StreamingView.cs - 流式消息视图
- `VideoView.cs` - 视频消息视图
- `GenericView.cs`、`WordCloudView.cs`、`SearchView.cs` 等

### 4. **Helper 层**
- MessageFormatHelper.cs - Markdown to HTML 转换、表格格式化等

### 5. **Interface 层**
- ISendMessageService.cs - 服务接口
- IView.cs - View 标记接口
- `IBotApiService.cs` - 新的服务标记接口

## 实施步骤（10 个阶段，52 个任务）

1. **Phase 1**: 创建项目和基础设施（4 个任务）
2. **Phase 2**: 迁移 Manager 层（4 个任务）
3. **Phase 3**: 迁移 Helper 层（3 个任务）
4. **Phase 4**: 迁移 Interface 层（5 个任务）
5. **Phase 5**: 迁移 Service 层（6 个任务）
6. **Phase 6**: 迁移 View 层（7 个任务）
7. **Phase 7**: 配置依赖注入（5 个任务）
8. **Phase 8**: 主项目集成和清理（7 个任务）
9. **Phase 9**: 测试与验证（6 个任务）
10. **Phase 10**: 文档更新（5 个任务）

## 关键设计决策

### 依赖关系
```
TelegramSearchBot.BotAPI
├── Telegram.Bot (SDK)
├── RateLimiter (速率限制)
├── Microsoft.Extensions.* (DI、日志、托管服务)
├── HtmlAgilityPack (HTML 处理)
├── Markdig (Markdown 解析)
└── TelegramSearchBot.Common (共享配置)

TelegramSearchBot (主项目)
└── TelegramSearchBot.BotAPI (项目引用)
```

### 命名空间映射
- `TelegramSearchBot.Manager` → `TelegramSearchBot.BotAPI.Manager`
- `TelegramSearchBot.Service.BotAPI` → `TelegramSearchBot.BotAPI.Service`
- `TelegramSearchBot.View` → `TelegramSearchBot.BotAPI.View`
- `TelegramSearchBot.Helper.MessageFormatHelper` → `TelegramSearchBot.BotAPI.Helper.MessageFormatHelper`

## 风险缓解

1. **命名空间冲突**: 使用 IDE 全局搜索替换，并在 CI 中添加编译检查
2. **循环依赖**: 避免依赖主项目的业务模型，使用 Telegram.Bot SDK 的类型
3. **DI 扫描失效**: 创建 `AddTelegramBotAPI()` 扩展方法显式注册服务
4. **测试覆盖**: 优先编写集成测试覆盖关键发送路径

## 下一步行动

完整的实施计划文档应保存在 `plan/refactor-telegram-api-extension-1.md`。你可以：

1. **立即开始**: 按照 Phase 1 创建新项目
2. **渐进式迁移**: 每完成一个 Phase 就测试一次
3. **并行开发**: Phase 2-6 的迁移任务可以并行进行