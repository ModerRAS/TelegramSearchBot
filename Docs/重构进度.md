# TelegramSearchBot Orleans 重构进度

## Phase 0: 准备与基础架构

- **Task 0.1: Grain 接口定义**: 完成。
  - C# 接口已在 `TelegramSearchBot/Interfaces/` 目录下定义。
  - `Microsoft.Orleans.Core.Abstractions` NuGet 包已添加到主项目。

- **Task 0.2: Orleans 项目集成与 Silo/Client 配置**: 部分完成。
  - 相关的 Orleans NuGet 包 (v9.1.2) 已添加到 `TelegramSearchBot.csproj`。
  - 已尝试在 `TelegramSearchBot/AppBootstrap/GeneralBootstrap.cs` 中配置 Silo Host (`UseOrleans`, `UseLocalhostClustering`)。
  - **注意**: 根据最新反馈，新版 Orleans (7.0.0+) 不需要显式配置 `ConfigureApplicationParts` 来发现同一项目中的 Grains，Orleans 的默认机制会自动处理。因此，之前与此相关的编译问题已通过移除不必要的配置代码解决。Silo 将使用默认序列化器。

- **Task 0.3: Stream ID 和消息模型定义**: 完成。
  - `OrleansStreamConstants.cs` (包含 Stream ID 和命名空间定义) 已创建在 `TelegramSearchBot/Model/`。
  - `StreamMessage<T>.cs` (通用消息包装类) 已创建在 `TelegramSearchBot/Model/`。

- **Task 0.4: 消息入口适配器与功能开关机制**: 部分完成。
  - `FeatureToggleService.cs` (用于管理功能开关) 已创建在 `TelegramSearchBot/Service/Common/`。
  - `HandleUpdateAsync` 方法在 `TelegramSearchBot/AppBootstrap/GeneralBootstrap.cs` 中已修改，以包含基于功能开关的路由逻辑。
  - **注意**: 将消息实际发布到 Orleans Streams 的代码已取消注释，并且在 Stream 包正确安装的情况下，现在应该是可编译和功能正常的。

**总结**: Phase 0 的编码结构已按计划完成。Grain 接口、Stream 常量、消息模型、功能开关以及消息到 Stream 的发布逻辑均已实现。Orleans Silo Host 的基础配置已完成，并将依赖新版 Orleans 的默认机制进行 Grain 发现。

---

## Phase 1: 核心 Grain 实现

- **Task 1.1: `TelegramMessageSenderGrain` 实现**: 已完成。
  - 已实现：
    - 文本消息发送、删除
    - 编辑消息（EditMessageText、EditMessageReplyMarkup）
    - 发送图片、视频、文件（SendPhoto、SendVideo、SendDocument）
    - 所有API调用已更新到最新版Telegram.Bot SDK格式（移除Async后缀）

- **其他Grain API更新**:
  - 已将所有Orleans相关Grain中过时的Telegram API调用更新到最新版（如GetMe, AnswerCallbackQuery, GetFile等）
  - AsrGrain, OcrGrain, QrCodeScanGrain等中的GetFile实现已更新

- **Task 1.2: `OcrGrain` 实现**: 完成。
  - 已实现：
    - 图片OCR，支持"打印"caption主动回复
    - 结果流转

- **Task 1.3: `QrCodeScanGrain` 实现**: 完成。
  - 已实现：
    - 二维码识别、回复、流转

- **Task 1.4: `AsrGrain` 实现**: 部分完成。
  - 已实现：
    - 音频/语音/视频ASR，长文本自动转.srt文件并通过Grain发送
  - 待补充：
    - 资源释放优化

- **Task 1.5: `UrlExtractionGrain` 实现**: 完成。
  - 已实现：
    - 自动URL处理、/resolveurls命令、短链映射存储

- **Task 1.6: `LlmProcessingGrain` 实现**: 部分完成。
  - 已实现：
    - 基本LLM交互
  - 待补充：
    - 多渠道LLM、上下文管理、工具调用

- **Task 1.7: `CommandParsingGrain` 实现**: 主流程骨架已补充。
  - 已实现：
    - 所有Bot命令分发、权限校验主流程
    - /help完整输出
    - 管理群、B站配置等命令均有全局管理员判断和TODO注释
  - 待补充：
    - 具体业务实现细节

- **Task 1.8: `BilibiliLinkProcessingGrain` 实现**: 主流程骨架已补充。
  - 已实现：
    - 视频、动态、专栏（cv）主流程分发
    - 专栏（cv）接口、数据模型已补充，主流程无编译错误
    - 下载、配置管理主流程骨架
  - 待补充：
    - 具体专栏（cv）信息抓取实现
    - 视频下载、文件大小判断、配置管理细节

- **Task 1.9: `CallbackQueryHandlerGrain` 实现**: 完成。

- **Task 1.10: `SearchQueryGrain` 实现**: 完成。
  - 已实现：
    - 优先编辑原消息分页，体验与原Bot一致

- **Task 1.11: `FileDownloadGrain` 实现**: 未开始。
- **Task 1.12: `MessageStorageGrain` 实现**: 未开始。
- **Task 1.13: `AuthGrain` 实现**: 未开始。

---

## 说明
- 所有补充点均严格复刻原有Bot逻辑，不涉及数据库结构和业务流程变更。
- 其余Grain如下载、存储、权限等需按原有实现补充。

**当前所有主流程已无编译错误，所有接口和数据模型已补全，所有过时API调用已更新，后续可按需完善具体业务实现。**
