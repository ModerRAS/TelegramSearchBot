# TelegramSearchBot Orleans 重构进度

## Phase 0: 准备与基础架构

- **Task 0.1: Grain 接口定义**: 完成。
  - C# 接口已在 `TelegramSearchBot/Interfaces/` 目录下定义。
  - `Microsoft.Orleans.Core.Abstractions` NuGet 包已添加到主项目。

- **Task 0.2: Orleans 项目集成与 Silo/Client 配置**: 部分完成。
  - 相关的 Orleans NuGet 包 (v9.1.2) 已添加到 `TelegramSearchBot.csproj`。
  - 已尝试在 `TelegramSearchBot/AppBootstrap/GeneralBootstrap.cs` 中配置 Silo Host (`UseOrleans`, `UseLocalhostClustering`)。
  - **注意**: 根据最新反馈，新版 Orleans (7.0.0+) 不需要显式配置 `ConfigureApplicationParts` 来发现同一项目中的 Grains，Orleans 的默认机制会自动处理。因此，之前与此相关的编译问题已通过移除不必要的配置代码解决。Silo 将使用默认序列化器。

- **Task 0.3: Stream ID 和消息模型定义**: 完成。
  - `OrleansStreamConstants.cs` (包含 Stream ID 和命名空间定义) 已创建在 `TelegramSearchBot/Model/`。
  - `StreamMessage<T>.cs` (通用消息包装类) 已创建在 `TelegramSearchBot/Model/`。

- **Task 0.4: 消息入口适配器与功能开关机制**: 部分完成。
  - `FeatureToggleService.cs` (用于管理功能开关) 已创建在 `TelegramSearchBot/Service/Common/`。
  - `HandleUpdateAsync` 方法在 `TelegramSearchBot/AppBootstrap/GeneralBootstrap.cs` 中已修改，以包含基于功能开关的路由逻辑。
  - **注意**: 将消息实际发布到 Orleans Streams 的代码已取消注释，并且在 Stream 包正确安装的情况下，现在应该是可编译和功能正常的。

**总结**: Phase 0 的编码结构已按计划完成。Grain 接口、Stream 常量、消息模型、功能开关以及消息到 Stream 的发布逻辑均已实现。Orleans Silo Host 的基础配置已完成，并将依赖新版 Orleans 的默认机制进行 Grain 发现。

---

## Phase 1: 核心 Grain 实现

- **Task 1.1: `TelegramMessageSenderGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/TelegramMessageSenderGrain.cs` 已创建。
  - 该 Grain 实现了 `ITelegramMessageSenderGrain` 接口，并使用注入的 `ITelegramBotClient` 来发送消息。
  - 已处理 `ReplyToMessageId` 的正确用法 (使用 `ReplyParameters`)。

- **Task 1.2: `OcrGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/OcrGrain.cs` 已创建并实现。
  - Grain 订阅 `RawImageMessages` Stream，使用 `ITelegramBotClient.GetFile/DownloadFile` 下载图片。
  - 调用 `PaddleOCR.Execute` 处理图像（基于 `OCRBootstrap.cs` 参考），并将结果发布到 `TextContentToProcess` Stream。

- **Task 1.3: `QrCodeScanGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/QrCodeScanGrain.cs` 已创建并实现。
  - Grain 订阅 `RawImageMessages` Stream，使用 `ITelegramBotClient.GetFile/DownloadFile` 下载图片。
  - `QRManager` 已注册到依赖注入容器。
  - 调用 `QRManager.ExecuteAsync` 处理图像（基于 `QRBootstrap.cs` 参考），并将结果发布到 `TextContentToProcess` Stream。

- **Task 1.4: `AsrGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/AsrGrain.cs` 已创建并实现。
  - Grain 订阅 `RawAudioMessagesStreamName` Stream，使用注入的 `ITelegramBotClient` 下载音频。
  - **设计改进**: 原先通过静态方法 `IProcessAudio.ConvertToWav` 进行音频转换的方式已重构。
    - 新增 `IAudioProcessingService` 接口 (位于 `TelegramSearchBot/Interfaces/`)。
    - 新增 `AudioProcessingService` 实现类 (位于 `TelegramSearchBot/Service/Media/`)，该服务通过依赖注入提供，并封装了包括 `ConvertToWavAsync` 在内的原 `IProcessAudio` 中的核心逻辑。
    - `AsrGrain` 现在注入并使用 `IAudioProcessingService` 来进行音频转换。
    - 旧的 `TelegramSearchBot/Intrerface/IProcessAudio.cs` 中的方法已标记为 `[Obsolete]`。
    - `IAudioProcessingService` 已在 `GeneralBootstrap.cs` 中注册。
  - 调用 `WhisperManager.DetectAsync` 处理音频（基于 `ASRBootstrap.cs` 参考），并将结果发布到 `TextContentToProcess` Stream。

- **Task 1.5: `UrlExtractionGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/UrlExtractionGrain.cs` 已创建并实现。
  - Grain 订阅 `TextContentToProcess` Stream。
  - 使用注入的 `UrlProcessingService.ProcessUrlsInTextAsync` 提取和初步处理（展开、清理）文本中的 URL。
  - 将提取到的 URL 信息通过 `ITelegramMessageSenderGrain` 回复给用户。
  - （获取网页标题的功能目前未在 `UrlProcessingService` 中实现，因此 Grain 未包含此功能）。

- **Task 1.6: `LlmProcessingGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/LlmProcessingGrain.cs` 已创建并实现。
  - Grain 订阅 `TextContentToProcess` Stream，并根据命令前缀（例如 `/ask `）触发。
  - 使用注入的 `GeneralLLMService.ExecAsync` 与大语言模型交互。
  - 将 LLM 的响应通过 `ITelegramMessageSenderGrain` 回复给用户。

- **Task 1.7: `CommandParsingGrain` 实现**: 扩展。
  - `TelegramSearchBot/Grains/CommandParsingGrain.cs` 已更新。
  - Grain 实现了 `ICommandParsingGrain` 接口，并订阅 `RawCommandMessagesStreamName` Stream。
  - 能够解析命令文本，对 `/start` 和 `/help` 命令进行基本响应。
  - **新增**: 添加了对 `/search` (和别名 `/s`) 命令的处理。当收到搜索命令时，会提取关键词，生成唯一的 Grain ID，并激活 `ISearchQueryGrain` 实例，调用其 `StartSearchAsync` 方法。
  - `CommandParsingGrain` 在分派给 `ISearchQueryGrain` 后不再直接回复用户，搜索相关的回复由 `SearchQueryGrain` 处理。
  - 其他复杂命令处理逻辑和分发到其他专用 Grains 的功能待进一步实现。
  - 对于直接处理的简单命令，通过 `ITelegramMessageSenderGrain` 回复用户。

- **Task 1.8: `BilibiliLinkProcessingGrain` 实现**: 初步完成。
  - `TelegramSearchBot/Grains/BilibiliLinkProcessingGrain.cs` 已创建。
  - Grain 实现了 `IBilibiliLinkProcessingGrain` 接口，并订阅 `TextContentToProcessStreamName` Stream。
  - 依赖 `IBiliApiService` (已在 `GeneralBootstrap.cs` 中注册) 和 `IGrainFactory`。
  - 能够使用正则表达式检测文本中的 Bilibili 视频 (BV/av/b23.tv) 和动态 (t.bilibili.com) 链接。
  - 调用 `IBiliApiService` 的 `GetVideoInfoAsync` 和 `GetOpusInfoAsync` 方法获取信息。
  - 将获取到的视频和动态信息格式化并通过 `ITelegramMessageSenderGrain` 回复给用户。
  - 对 Bilibili 文章 (cv) 链接的检测已添加，但具体处理逻辑待 `IBiliApiService` 支持。
  - 包含对已处理 URL 的去重逻辑，避免重复发送信息。

- **Task 1.10: `SearchQueryGrain` 实现**: 初步完成。
  - `ISearchQueryGrain` 接口已在 `TelegramSearchBot/Interfaces/` 目录中定义。
  - `SearchQueryGrain.cs` 文件已在 `TelegramSearchBot/Grains/` 目录中创建。
  - Grain 实现了 `ISearchQueryGrain` 接口，并使用 `IPersistentState<SearchQueryState>` 进行状态管理。
  - 依赖 `ISearchService` (已在 `GeneralBootstrap.cs` 中注册其实现 `SearchService`) 和 `IGrainFactory` (获取 `ITelegramMessageSenderGrain`)。
  - `StartSearchAsync` 方法：初始化搜索状态，调用 `ISearchService` 执行搜索，格式化结果，并通过 `ITelegramMessageSenderGrain` 发送包含分页按钮的初始消息。
  - `HandlePagingActionAsync` 方法：处理分页动作（上一页、下一页、取消），更新状态，重新执行搜索并更新消息。
  - **注意**: 当前分页实现通过发送新消息完成，因为 `ITelegramMessageSenderGrain` 尚不支持编辑消息文本和ReplyMarkup。此为已知待改进点。
  - CallbackData 格式为 `searchgrain:<grainId>:<action>[:<pageNumber>]`。

- **Task 1.9: `CallbackQueryHandlerGrain` 实现**: 初步完成。
  - `TelegramSearchBot/Grains/CallbackQueryHandlerGrain.cs` 已创建。
  - Grain 实现了 `ICallbackQueryHandlerGrain` 接口，并订阅 `RawCallbackQueryMessagesStreamName` Stream。
  - 依赖 `IGrainFactory` (获取目标 Grain) 和 `ITelegramBotClient` (用于 `AnswerCallbackQueryAsync`)。
  - 能够解析特定格式的回调数据 (目前为 `searchgrain:<grainId>:<action>[:<pageNumber>]`)。
  - 将解析后的动作和参数分派给相应的 `ISearchQueryGrain` 实例进行处理。
  - 调用 `_botClient.AnswerCallbackQueryAsync` 响应 Telegram API。
  - 其他类型回调数据的处理逻辑待添加。
