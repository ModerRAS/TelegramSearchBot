# TelegramSearchBot Orleans 重构进度

## Phase 0: 准备与基础架构

- **Task 0.1: Grain 接口定义**: 完成。
  - C# 接口已在 `TelegramSearchBot/Interfaces/` 目录下定义。
  - `Microsoft.Orleans.Core.Abstractions` NuGet 包已添加到主项目。

- **Task 0.2: Orleans 项目集成与 Silo/Client 配置**: 部分完成。
  - 相关的 Orleans NuGet 包 (v9.1.2) 已添加到 `TelegramSearchBot.csproj`。
  - 已尝试在 `TelegramSearchBot/AppBootstrap/GeneralBootstrap.cs` 中配置 Silo Host (`UseOrleans`, `UseLocalhostClustering`)。
  - **注意**: 根据最新反馈，新版 Orleans (7.0.0+) 不需要显式配置 `ConfigureApplicationParts` 来发现同一项目中的 Grains，Orleans 的默认机制会自动处理。因此，之前与此相关的编译问题已通过移除不必要的配置代码解决。Silo 将使用默认序列化器。

- **Task 0.3: Stream ID 和消息模型定义**: 完成。
  - `OrleansStreamConstants.cs` (包含 Stream ID 和命名空间定义) 已创建在 `TelegramSearchBot/Model/`。
  - `StreamMessage<T>.cs` (通用消息包装类) 已创建在 `TelegramSearchBot/Model/`。

- **Task 0.4: 消息入口适配器与功能开关机制**: 部分完成。
  - `FeatureToggleService.cs` (用于管理功能开关) 已创建在 `TelegramSearchBot/Service/Common/`。
  - `HandleUpdateAsync` 方法在 `TelegramSearchBot/AppBootstrap/GeneralBootstrap.cs` 中已修改，以包含基于功能开关的路由逻辑。
  - **注意**: 将消息实际发布到 Orleans Streams 的代码已取消注释，并且在 Stream 包正确安装的情况下，现在应该是可编译和功能正常的。

**总结**: Phase 0 的编码结构已按计划完成。Grain 接口、Stream 常量、消息模型、功能开关以及消息到 Stream 的发布逻辑均已实现。Orleans Silo Host 的基础配置已完成，并将依赖新版 Orleans 的默认机制进行 Grain 发现。

---

## Phase 1: 核心 Grain 实现

- **Task 1.1: `TelegramMessageSenderGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/TelegramMessageSenderGrain.cs` 已创建。
  - 该 Grain 实现了 `ITelegramMessageSenderGrain` 接口，并使用注入的 `ITelegramBotClient` 来发送消息。
  - 已处理 `ReplyToMessageId` 的正确用法 (使用 `ReplyParameters`)。

- **Task 1.2: `OcrGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/OcrGrain.cs` 已创建并实现。
  - Grain 订阅 `RawImageMessages` Stream，使用 `ITelegramBotClient.GetFile/DownloadFile` 下载图片。
  - 调用 `PaddleOCR.Execute` 处理图像（基于 `OCRBootstrap.cs` 参考），并将结果发布到 `TextContentToProcess` Stream。

- **Task 1.3: `QrCodeScanGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/QrCodeScanGrain.cs` 已创建并实现。
  - Grain 订阅 `RawImageMessages` Stream，使用 `ITelegramBotClient.GetFile/DownloadFile` 下载图片。
  - `QRManager` 已注册到依赖注入容器。
  - 调用 `QRManager.ExecuteAsync` 处理图像（基于 `QRBootstrap.cs` 参考），并将结果发布到 `TextContentToProcess` Stream。

- **Task 1.4: `AsrGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/AsrGrain.cs` 已创建并实现。
  - Grain 订阅 `RawAudioMessagesStreamName` Stream，使用 `ITelegramBotClient.GetFile/DownloadFile` 下载音频。
  - 使用 `IProcessAudio.ConvertToWav` 将音频转换为WAV格式。
  - 调用 `WhisperManager.DetectAsync` 处理音频（基于 `ASRBootstrap.cs` 参考），并将结果发布到 `TextContentToProcess` Stream。

- **Task 1.5: `UrlExtractionGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/UrlExtractionGrain.cs` 已创建并实现。
  - Grain 订阅 `TextContentToProcess` Stream。
  - 使用注入的 `UrlProcessingService.ProcessUrlsInTextAsync` 提取和初步处理（展开、清理）文本中的 URL。
  - 将提取到的 URL 信息通过 `ITelegramMessageSenderGrain` 回复给用户。
  - （获取网页标题的功能目前未在 `UrlProcessingService` 中实现，因此 Grain 未包含此功能）。

- **Task 1.6: `LlmProcessingGrain` 实现**: 完成。
  - `TelegramSearchBot/Grains/LlmProcessingGrain.cs` 已创建并实现。
  - Grain 订阅 `TextContentToProcess` Stream，并根据命令前缀（例如 `/ask `）触发。
  - 使用注入的 `GeneralLLMService.ExecAsync` 与大语言模型交互。
  - 将 LLM 的响应通过 `ITelegramMessageSenderGrain` 回复给用户。
