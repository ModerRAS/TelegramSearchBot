using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using TelegramSearchBot.Domain.Message;
using TelegramSearchBot.Test.Helpers;
using TelegramSearchBot.Test.Integration;
using Xunit;
using Xunit.Abstractions;

namespace TelegramSearchBot.Test.Integration
{
    /// <summary>
    /// AIå¤„ç†é›†æˆæµ‹è¯•
    /// </summary>
    public class AIProcessingIntegrationTests : IntegrationTestBase
    {
        public AIProcessingIntegrationTests(ITestOutputHelper output) : base(output)
        {
        }

        [Fact]
        public async Task ProcessOCRRequest_ShouldExtractTextFromImage()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var imageMessage = TestDataFactory.CreatePhotoMessage();
                var ocrService = GetService<IImageOCRService>();

                // Act
                StartPerformanceMonitoring();
                var extractedText = await ocrService.ExtractTextAsync(new byte[] { 0x01, 0x02, 0x03 }); // æ¨¡æ‹Ÿå›¾ç‰‡æ•°æ®
                var processingTime = StopPerformanceMonitoring("OCRProcessing");

                // Assert
                Assert.NotNull(extractedText);
                Assert.NotEmpty(extractedText);
                Assert.Contains("å›¾ç‰‡", extractedText); // Mockè¿”å›çš„æ•°æ®åº”è¯¥åŒ…å«å…³é”®è¯

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 5000, $"OCRå¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 5000ms");

                LogTestInfo($"OCRå¤„ç†æµ‹è¯•é€šè¿‡ï¼Œæå–æ–‡æœ¬: {extractedText}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessASRRequest_ShouldConvertSpeechToText()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var audioMessage = TestDataFactory.CreateVoiceMessage();
                var asrService = GetService<ISpeechToTextService>();

                // Act
                StartPerformanceMonitoring();
                var convertedText = await asrService.ConvertSpeechToTextAsync(new byte[] { 0x01, 0x02, 0x03 }); // æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®
                var processingTime = StopPerformanceMonitoring("ASRProcessing");

                // Assert
                Assert.NotNull(convertedText);
                Assert.NotEmpty(convertedText);
                Assert.Contains("è¯­éŸ³", convertedText); // Mockè¿”å›çš„æ•°æ®åº”è¯¥åŒ…å«å…³é”®è¯

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 8000, $"ASRå¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 8000ms");

                LogTestInfo($"ASRå¤„ç†æµ‹è¯•é€šè¿‡ï¼Œè½¬æ¢æ–‡æœ¬: {convertedText}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessLLMChatRequest_ShouldGenerateResponse()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var prompt = "è¯·è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var response = await llmService.ChatAsync(prompt);
                var processingTime = StopPerformanceMonitoring("LLMChatProcessing");

                // Assert
                Assert.NotNull(response);
                Assert.NotEmpty(response);
                Assert.Contains("æ¨¡æ‹Ÿå›å¤", response); // Mockè¿”å›çš„æ•°æ®åº”è¯¥åŒ…å«å…³é”®è¯

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 10000, $"LLMèŠå¤©å¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 10000ms");

                LogTestInfo($"LLMèŠå¤©æµ‹è¯•é€šè¿‡ï¼Œå›å¤: {response}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessLLMEmbeddingRequest_ShouldGenerateVector()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var text = "è¿™æ˜¯ä¸€æ®µéœ€è¦ç”Ÿæˆå‘é‡çš„æ–‡æœ¬";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var embedding = await llmService.GenerateEmbeddingsAsync(text);
                var processingTime = StopPerformanceMonitoring("LLMEmbeddingProcessing");

                // Assert
                Assert.NotNull(embedding);
                Assert.NotEmpty(embedding);
                Assert.StartsWith("[", embedding); // åº”è¯¥æ˜¯æ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²
                Assert.EndsWith("]", embedding);

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 5000, $"LLMåµŒå…¥å¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 5000ms");

                LogTestInfo($"LLMåµŒå…¥æµ‹è¯•é€šè¿‡ï¼Œå‘é‡é•¿åº¦: {embedding.Length}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessLLMSummarizationRequest_ShouldGenerateSummary()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var longText = "è¿™æ˜¯ä¸€æ®µå¾ˆé•¿çš„æ–‡æœ¬å†…å®¹ï¼Œéœ€è¦è¢«æ€»ç»“æˆç®€æ´çš„æ‘˜è¦ã€‚åŒ…å«äº†å¾ˆå¤šé‡è¦çš„ä¿¡æ¯å’Œç»†èŠ‚ã€‚";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var summary = await llmService.SummarizeAsync(longText);
                var processingTime = StopPerformanceMonitoring("LLMSummarizationProcessing");

                // Assert
                Assert.NotNull(summary);
                Assert.NotEmpty(summary);
                Assert.Contains("æ¨¡æ‹Ÿæ‘˜è¦", summary); // Mockè¿”å›çš„æ•°æ®åº”è¯¥åŒ…å«å…³é”®è¯

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 8000, $"LLMæ‘˜è¦å¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 8000ms");

                LogTestInfo($"LLMæ‘˜è¦æµ‹è¯•é€šè¿‡ï¼Œæ‘˜è¦: {summary}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessLLMTranslationRequest_ShouldTranslateText()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var text = "Hello, how are you?";
                var targetLanguage = "zh";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var translation = await llmService.TranslateAsync(text, targetLanguage);
                var processingTime = StopPerformanceMonitoring("LLMTranslationProcessing");

                // Assert
                Assert.NotNull(translation);
                Assert.NotEmpty(translation);
                Assert.Contains("æ¨¡æ‹Ÿ", translation); // Mockè¿”å›çš„æ•°æ®åº”è¯¥åŒ…å«å…³é”®è¯

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 6000, $"LLMç¿»è¯‘å¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 6000ms");

                LogTestInfo($"LLMç¿»è¯‘æµ‹è¯•é€šè¿‡ï¼Œç¿»è¯‘: {translation}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessLLMSentimentAnalysisRequest_ShouldAnalyzeSentiment()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var text = "æˆ‘éå¸¸å–œæ¬¢è¿™ä¸ªäº§å“ï¼Œå®ƒéå¸¸å®ç”¨ï¼";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var sentiment = await llmService.AnalyzeSentimentAsync(text);
                var processingTime = StopPerformanceMonitoring("LLMSentimentAnalysisProcessing");

                // Assert
                Assert.NotNull(sentiment);
                Assert.NotEmpty(sentiment);
                Assert.Contains("sentiment", sentiment); // åº”è¯¥åŒ…å«æƒ…æ„Ÿåˆ†æç»“æœ

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 4000, $"LLMæƒ…æ„Ÿåˆ†æå¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 4000ms");

                LogTestInfo($"LLMæƒ…æ„Ÿåˆ†ææµ‹è¯•é€šè¿‡ï¼Œç»“æœ: {sentiment}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessLLMKeywordExtractionRequest_ShouldExtractKeywords()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var text = "äººå·¥æ™ºèƒ½å’Œæœºå™¨å­¦ä¹ åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸæœ‰å¹¿æ³›çš„åº”ç”¨";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var keywords = await llmService.ExtractKeywordsAsync(text);
                var processingTime = StopPerformanceMonitoring("LLMKeywordExtractionProcessing");

                // Assert
                Assert.NotNull(keywords);
                Assert.NotEmpty(keywords);
                Assert.Contains("å…³é”®è¯", keywords); // Mockè¿”å›çš„æ•°æ®åº”è¯¥åŒ…å«å…³é”®è¯

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 5000, $"LLMå…³é”®è¯æå–å¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 5000ms");

                LogTestInfo($"LLMå…³é”®è¯æå–æµ‹è¯•é€šè¿‡ï¼Œå…³é”®è¯: {keywords}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessConcurrentAIRequests_ShouldHandleParallelProcessing()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var llmService = GetService<IGeneralLLMService>();
                var prompts = new[]
                {
                    "è§£é‡Šä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ",
                    "ä»€ä¹ˆæ˜¯è‡ªç„¶è¯­è¨€å¤„ç†",
                    "æœºå™¨å­¦ä¹ æœ‰å“ªäº›åº”ç”¨",
                    "ä»€ä¹ˆæ˜¯ç¥ç»ç½‘ç»œ"
                };

                // Act
                StartPerformanceMonitoring();
                
                var tasks = prompts.Select(async prompt =>
                {
                    return await llmService.ChatAsync(prompt);
                });
                
                var results = await Task.WhenAll(tasks);
                var totalProcessingTime = StopPerformanceMonitoring("ConcurrentAIProcessing");

                // Assert
                Assert.Equal(prompts.Length, results.Length);
                Assert.All(results, result => 
                {
                    Assert.NotNull(result);
                    Assert.NotEmpty(result);
                });

                // éªŒè¯æ€§èƒ½
                var averageTimePerRequest = totalProcessingTime / prompts.Length;
                Assert.True(averageTimePerRequest < 12000, $"å¹³å‡æ¯ä¸ªAIè¯·æ±‚å¤„ç†æ—¶é—´ {averageTimePerRequest}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 12000ms");

                LogTestInfo($"å¹¶å‘AIå¤„ç†æµ‹è¯•é€šè¿‡ï¼Œå¤„ç† {prompts.Length} ä¸ªè¯·æ±‚ï¼Œæ€»æ—¶é—´: {totalProcessingTime}msï¼Œå¹³å‡: {averageTimePerRequest}ms");
            });
        }

        [Fact]
        public async Task ProcessAIPipeline_ShouldHandleMultipleAISteps()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var originalText = "è¿™æ˜¯ä¸€æ®µåŒ…å«å›¾ç‰‡å’Œè¯­éŸ³çš„å¤šåª’ä½“æ¶ˆæ¯å†…å®¹";
                var llmService = GetService<IGeneralLLMService>();

                // Act - æ¨¡æ‹Ÿå®Œæ•´çš„AIå¤„ç†ç®¡é“
                StartPerformanceMonitoring();
                
                // æ­¥éª¤1: ç”ŸæˆåµŒå…¥å‘é‡
                var embedding = await llmService.GenerateEmbeddingsAsync(originalText);
                
                // æ­¥éª¤2: æƒ…æ„Ÿåˆ†æ
                var sentiment = await llmService.AnalyzeSentimentAsync(originalText);
                
                // æ­¥éª¤3: å…³é”®è¯æå–
                var keywords = await llmService.ExtractKeywordsAsync(originalText);
                
                // æ­¥éª¤4: æ‘˜è¦ç”Ÿæˆ
                var summary = await llmService.SummarizeAsync(originalText);
                
                var totalProcessingTime = StopPerformanceMonitoring("AIPipelineProcessing");

                // Assert
                Assert.NotNull(embedding);
                Assert.NotNull(sentiment);
                Assert.NotNull(keywords);
                Assert.NotNull(summary);

                Assert.NotEmpty(embedding);
                Assert.NotEmpty(sentiment);
                Assert.NotEmpty(keywords);
                Assert.NotEmpty(summary);

                // éªŒè¯æ€§èƒ½
                Assert.True(totalProcessingTime < 20000, $"AIç®¡é“å¤„ç†æ—¶é—´ {totalProcessingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 20000ms");

                LogTestInfo($"AIç®¡é“å¤„ç†æµ‹è¯•é€šè¿‡ï¼Œå®Œæˆ4ä¸ªAIæ­¥éª¤ï¼Œæ€»æ—¶é—´: {totalProcessingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessAIWithLargeInput_ShouldHandleLongText()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var longText = string.Join(" ", Enumerable.Range(1, 1000).Select(i => $"è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„æ–‡æœ¬å†…å®¹{i}ï¼Œç”¨äºæµ‹è¯•AIå¤„ç†å¤§æ–‡æœ¬çš„èƒ½åŠ›ã€‚"));
                var llmService = GetService<IGeneralLLMService>();

                // Act
                StartPerformanceMonitoring();
                var summary = await llmService.SummarizeAsync(longText);
                var processingTime = StopPerformanceMonitoring("AILargeTextProcessing");

                // Assert
                Assert.NotNull(summary);
                Assert.NotEmpty(summary);
                Assert.True(longText.Length > 10000, "è¾“å…¥æ–‡æœ¬åº”è¯¥è¶…è¿‡10000å­—ç¬¦");

                // éªŒè¯æ€§èƒ½
                Assert.True(processingTime < 15000, $"AIå¤§æ–‡æœ¬å¤„ç†æ—¶é—´ {processingTime}ms è¶…è¿‡é¢„æœŸé˜ˆå€¼ 15000ms");

                LogTestInfo($"AIå¤§æ–‡æœ¬å¤„ç†æµ‹è¯•é€šè¿‡ï¼Œè¾“å…¥é•¿åº¦: {longText.Length}å­—ç¬¦ï¼Œæ‘˜è¦: {summary}ï¼Œå¤„ç†æ—¶é—´: {processingTime}ms");
            });
        }

        [Fact]
        public async Task ProcessAIWithSpecialContent_ShouldHandleUnicodeAndEmoji()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var specialText = "æµ‹è¯•æ¶ˆæ¯åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼šğŸ‰ğŸ˜ŠğŸš€ ä»¥åŠä¸­æ–‡ã€Englishã€æ—¥æœ¬èªã€í•œêµ­ì–´";
                var llmService = GetService<IGeneralLLMService>();

                // Act
                var embedding = await llmService.GenerateEmbeddingsAsync(specialText);

                // Assert
                Assert.NotNull(embedding);
                Assert.NotEmpty(embedding);

                LogTestInfo($"AIç‰¹æ®Šå†…å®¹å¤„ç†æµ‹è¯•é€šè¿‡ï¼Œå¤„ç†åŒ…å«emojiå’Œå¤šè¯­è¨€çš„å†…å®¹");
            });
        }

        [Fact]
        public async Task ProcessAIServiceAvailability_ShouldHandleServiceHealthChecks()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var ocrService = GetService<IImageOCRService>();
                var asrService = GetService<ISpeechToTextService>();
                var llmService = GetService<IGeneralLLMService>();

                // Act - æµ‹è¯•å„ä¸ªAIæœåŠ¡çš„å¯ç”¨æ€§
                var imageData = new byte[] { 0x01, 0x02, 0x03 };
                var audioData = new byte[] { 0x04, 0x05, 0x06 };

                var ocrAvailable = await ocrService.IsImageProcessableAsync(imageData);
                var asrAvailable = await asrService.IsAudioProcessableAsync(audioData);
                var llmResponse = await llmService.ChatAsync("æµ‹è¯•æ¶ˆæ¯");

                // Assert
                Assert.True(ocrAvailable, "OCRæœåŠ¡åº”è¯¥å¯ç”¨");
                Assert.True(asrAvailable, "ASRæœåŠ¡åº”è¯¥å¯ç”¨");
                Assert.NotNull(llmResponse);
                Assert.NotEmpty(llmResponse);

                LogTestInfo($"AIæœåŠ¡å¯ç”¨æ€§æµ‹è¯•é€šè¿‡ï¼ŒOCR: {ocrAvailable}, ASR: {asrAvailable}, LLM: æ­£å¸¸");
            });
        }

        [Fact]
        public async Task ProcessAIErrorHandling_ShouldHandleInvalidInput()
        {
            await ExecuteTestAsync(async () =>
            {
                // Arrange
                var llmService = GetService<IGeneralLLMService>();

                // Act - æµ‹è¯•ç©ºè¾“å…¥
                var emptyResponse = await llmService.ChatAsync("");
                var nullResponse = await llmService.ChatAsync(null!);

                // Assert - MockæœåŠ¡åº”è¯¥èƒ½å¤Ÿå¤„ç†ç©ºè¾“å…¥
                Assert.NotNull(emptyResponse);
                Assert.NotNull(nullResponse);

                LogTestInfo($"AIé”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡ï¼Œèƒ½å¤Ÿå¤„ç†ç©ºè¾“å…¥å’Œnullè¾“å…¥");
            });
        }
    }
}